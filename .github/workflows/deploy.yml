name: Deploy to GCE

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH and Deploy
        env:
          SSH_PRIVATE_KEY: ${{ secrets.GCE_SSH_KEY }}
          SSH_HOST: ${{ secrets.GCE_HOST }}
          SSH_USER: ${{ secrets.GCE_USERNAME }}
        run: |
          install -m 700 -d ~/.ssh
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null

          eval $(ssh-agent -s)
          printf '%s\n' "$SSH_PRIVATE_KEY" | ssh-add -

          echo "=== Offered key types ==="
          ssh-add -l

          ssh -v \
            -o ConnectTimeout=30 \
            -o PubkeyAcceptedAlgorithms=+ssh-rsa \
            "$SSH_USER@$SSH_HOST" \
            'cd ~/tavern-discord-bot && git pull origin main && npm install && pm2 restart discord-bot'
