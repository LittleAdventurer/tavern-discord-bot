name: Deploy to GCE

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to GCE VM
        env:
          SSH_PRIVATE_KEY: ${{ secrets.GCE_SSH_KEY }}
          SSH_HOST: ${{ secrets.GCE_HOST }}
          SSH_USER: ${{ secrets.GCE_USERNAME }}
        run: |
          install -m 700 -d ~/.ssh
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null

          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keygen -y -f ~/.ssh/deploy_key > /dev/null || { echo "::error::Invalid SSH private key"; exit 1; }

          echo "=== Deploy key fingerprint ==="
          ssh-keygen -lf ~/.ssh/deploy_key

          ssh -i ~/.ssh/deploy_key \
            -o ConnectTimeout=30 \
            -o IdentitiesOnly=yes \
            "$SSH_USER@$SSH_HOST" \
            'if [ ! -d ~/tavern-discord-bot ]; then git clone https://github.com/'"$GITHUB_REPOSITORY"'.git ~/tavern-discord-bot; fi && cd ~/tavern-discord-bot && git pull origin main && npm install && pm2 restart discord-bot'
